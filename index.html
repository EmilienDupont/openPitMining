<!DOCTYPE html>
<meta charset="utf-8">
<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<script>
  MathJax.Hub.Config({
                      tex2jax: {inlineMath: [['$', '$'], ['\\(','\\)']]},
                      TeX: { equationNumbers: {autoNumber: "AMS"} },
                      "HTML-CSS": { showMathMenu: false,
                                    scale: 90 }

                     });
</script>
<style>

  rect:hover {
    opacity: .8;
  }
  
  .typea {
    fill: gray;
    color: gray;
  }
  
  .typeb {
    fill: silver;
    color: silver;
  }

  .typec {
    fill: brown;
    color: brown;
  }
  
  .typed {
    fill: gold;
    color: gold;
  }


</style>
<body>
  <ul id="nav">
    <li class="current"><a href="#intro">Intro</a></li>
    <li><a href="#problem">Problem</a></li>
    <li><a href="#model">Model</a></li>
    <li><a href="#implementation">Implementation</a></li>
    <li><a href="#demo">Live Demo</a></li>
  </ul>
  <div id="container">
    <div class="section" id="intro">
      <h1>Open Pit Mining</h1>
        <subtitle>with integer programming and Gurobi</subtitle>
    </div>

    <div class="section" id="problem">
      <h2><a href="#problem" name="problem">Problem Description</a></h2>
      Problem description goes here
    </div>
    <div class="section" id="model">
      <h2><a href="#model" name="model">Mathematical Model</a></h2>

      <p>Model description goes here.</p>
      <p> Right now, we have: Mine on level 1 => 100USD  level 2 => 200USD  level 3 => 300USD. Each block has a 1000 tons of rock
      </p>
    </div>
    <div class="section" id="implementation">
      <h2><a href="#implementation" name="implementation">Implementation</a></h2>
      <p>Below is the full implementation of the model (and the associated data) in
        Gurobi's Python interface:
      </p>
      <pre>
      cost = []; value = []; edges = []; !!! FILL THESE OUT !!!
        
      m = Model()

      n = len(cost) # number of blocks
      
      # Indicator variable for each block
      xb = {}
      for i in range(n):
          xb[i] = m.addVar(vtype=GRB.BINARY, name="x%d" % i)
      
      m.update()
      
      # Set objective
      m.setObjective(quicksum((value[i] - cost[i])*xb[i] for i in range(n)), GRB.MAXIMIZE)
      
      # Add constraints
      for edge in edges:
          u = edge[0]
          v = edge[1]
          m.addConstr(xb[u] <= xb[v])
      
      m.optimize()
      </pre>
    </div>
    <div class="section" id="demo">
      <h2><a href="#demo" name="demo">Live Demo</a></h2>
      <div id="demoarea">
      </div>
      <button onclick="compute()">Mine away!</button>
    </div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
<script>


// Create data for each layer of blocks
var numBlocks = 18
var blocks = [];
for (var i = 0; i < numBlocks; i++) {
  blocks.push(i);
}

var layer2 = 8; var layer3 = 14; 

// Different types
var types = ["typea","typeb","typec","typed"];

// Type variable
var type = "typea";

var width = 700,
    height = 500,
    size = width/(layer2 + 2);

// Create precedence graph
edges = [];

for (var i = 8; i < 14; i++) { // range(8,14)
    edges.push([i,i-8]);
    edges.push([i,i-7]);
    edges.push([i,i-6]);
}

for (var i = 14; i < 18; i++) { // range(14,18)
    edges.push([i,i-6])
    edges.push([i,i-5])
    edges.push([i,i-4])
}

// Create cost and value data
cost = [];
value = [];
for (var i = 0; i < numBlocks; i++) {
  if (i >= layer2 && i < layer3) {
    cost.push(200);
  }
  else if (i >= layer3) {
    cost.push(300);
  }
  else {
    cost.push(100);
  }
  value.push(0);
}

var profit = 0;

// Start graphics
var svg = d3.select("#demoarea").append("svg")
    .attr("width", width)
    .attr("height", height);

// Create background
var backgroundG = svg.append("g")
    backgroundG.append("polygon").attr("points", "0,210, 0,500, 700,500, 700,210")
                                 .attr("fill", "rgb(50,50,50)")
                                 .attr("stroke", "black")
                                 .attr("stroke-width", 3);
    backgroundG.append("polygon").attr("points", "0,210, 0,0, 700,0, 700,210")
                                 .attr("fill", "rgb(6,214,255)");
    backgroundG.append("circle").attr("cx", width - 100).attr("cy", 100).attr("r", 50).attr("fill", "yellow")
                                .attr("stroke", "orange").attr("stroke-width", 5);
    
var buttonsG = svg.append("g");

var buttons = buttonsG.selectAll("circle")
                 .data(types)
                 .enter()
                 .append("circle")
                 .on("mousedown", buttonpress);

    buttons.attr("cx",  function(d,i) {
                          return (i+.5)*size/2;
                        })
           .attr("cy", 20)
           .attr("r", 15)
           .attr("class", function(d) { return d;} )
           .attr("stroke", "black")
           .attr("stroke-width", 2);

var blocksG = svg.append("g");

var blockRect = blocksG.selectAll("rect")
                   .data(blocks)
                   .enter()
                   .append("rect")
                   .on("mousedown", mousedown);
  
    blockRect.attr("x", function(d) {
              console.log(d)
              if (d >= layer2 && d < layer3) {
                return (d + 2 - layer2)*size;
              }
              else if (d >= layer3) {
                return (d + 3 - layer3)*size;
              }
              else {
                return (d+1)*size;
              }
              })
              .attr("y", function(d) {
              if (d >= layer2 && d < layer3) {
                return 4*size;
              }
              else if (d >= layer3) {
                return 5*size;
              }
              else {
                return 3*size;
              }
              })
              .attr("height", size)
              .attr("width", size)
              .attr("stroke", "black")
              .attr("stroke-width", 1)
              .attr("class", function (d) {
                        var typeinitial;
                        if (d === 0 || d === 6 || d == 9 || d == 11 || d == 16 || d == 17) {
                           typeinitial = "typed";
                        } else {
                           typeinitial = "typea";
                        }
                        console.log(typeinitial)
                        return typeinitial;
                    });

var solutionG = svg.append("g");

var solutionRect = solutionG.selectAll("rect")
                  .on("mousedown", removeSol);

// sets type of clicked rectangle
function mousedown() {
  // Remove rectangles from previous solution
  solutionG.selectAll("rect")
           .remove();

  d3.select(this)
    .attr("class", type);
}

// Change the type
function buttonpress() {
  type = d3.select(this).attr("class")
  console.log(type)
}

function removeSol() {
  solutionG.selectAll("rect")
           .remove();
}

// Compute
function compute() {
  //cost = [100, 100, 100, 100, 100, 100, 100, 100, 1000, 200, 200, 200, 200, 1000, 1000, 1000, 300, 1000];
  //value = [200, 0, 0, 0, 0, 0, 300, 0, 0, 500, 0, 200, 0, 0, 0, 0, 1000, 1200];
  blocksG.selectAll("rect").attr("class", function(d) {
                                      var tempType = d3.select(this).attr("class");
                                      if (tempType === "typea") {
                                        value[d] = 0;
                                      }
                                      if (tempType === "typeb") {
                                        value[d] = 150;
                                      }
                                      if (tempType === "typec") {
                                        value[d] = 250;
                                      }
                                      if (tempType === "typed") {
                                        value[d] = 400;
                                      }
                                      return d3.select(this).attr("class");
                                    });
  
  console.log('cost',cost)
  console.log('value',value)
  console.log('edges',edges)
  
  d3.json('/resource')
    .header('Content-Type', 'application/json')
    .post(JSON.stringify({'cost': cost,
                          'value': value,
                          'edges': edges }), serverResponse);
}

function serverResponse(error, data) {
   console.log('serverResponse');
   console.log('data', data);
   if (!error) {
      if ('solution' in data) {
          // Import solution and put it into correct format
          var solution = data['solution'];
          var solTemp = [];
          profit = solution[solution.length - 1]; // Last element is profit
          
          console.log('test',solution)
          
          solution = solution.slice(0,solution.length-1);
          
          console.log('test',solution)
          
          for (var i = 0; i < solution.length; i++) {
            if (solution[i] === 1) {
              solTemp.push(i);
            }
          }
          solution = solTemp;
          console.log('solution', solution)
          console.log('profit', profit)
          
          solutionG.selectAll("rect")
                   .remove();
          
          var rectSol = solutionG.selectAll("rect")
                                   .data(solution)
                                   .enter()
                                   .append("rect");
          
          rectSol.attr("x", function(d) {
                      console.log(d)
                      if (d >= layer2 && d < layer3) {
                        return (d + 2 - layer2)*size;
                      }
                      else if (d >= layer3) {
                        return (d + 3 - layer3)*size;
                      }
                      else {
                        return (d+1)*size;
                      }
                      })
                      .attr("y", function(d) {
                      if (d >= layer2 && d < layer3) {
                        return 4*size;
                      }
                      else if (d >= layer3) {
                        return 5*size;
                      }
                      else {
                        return 3*size;
                      }
                      })
                      .attr("height", size)
                      .attr("width", size)
                      .attr("fill", "rgb(6,214,255)")
                      .attr("stroke", "rgb(6,214,255)")
                      .style("opacity", 0)
                      .style("stroke-opacity", 0)
                      .transition()
                      .style("opacity", 1)
                      .style("stroke-opacity", 1)
                      .duration(500)
                      .delay(function(i) { return i*100 });
          
          profit = 1000*profit;
          
          solutionG.selectAll("text").remove();
          
          solutionG.append("text")
                    .text("Profit: " + String(profit) + "$")
                    .attr("x", width/2)
                    .attr("y", 20)
                    .attr("font-family", "sans-serif")
                    .attr("font-size", "18px")
                    .attr("fill", "white")
                    .attr("text-anchor", "middle");
          
          
          solutionRect = solutionG.selectAll("rect")
                  .on("mousedown", removeSol);
        }
   }
}

</script>